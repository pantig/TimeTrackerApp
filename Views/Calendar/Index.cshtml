@using TimeTrackerApp.Models.ViewModels
@using TimeTrackerApp.Models
@model WeeklyTimeGridViewModel

@{
    ViewData["Title"] = "Kalendarz Tygodniowy";
}

<div class="timegrid-container">
    <div class="timegrid-header">
        <div class="timegrid-nav">
            <a asp-action="Index" asp-route-date="@Model.PrevWeek.ToString("yyyy-MM-dd")" asp-route-employeeId="@Model.EmployeeId" class="btn-calendar-nav">&laquo;</a>
            <div class="timegrid-title">
                <h2>@Model.WeekStart.ToString("d MMM") ‚Äì @Model.WeekEnd.ToString("d MMM yyyy")</h2>
                <div class="muted">
                    @if (Model.CanSelectEmployee && Model.AllEmployees != null)
                    {
                        <span>Pracownik: </span>
                        <select id="employeeSelect" class="employee-select" onchange="changeEmployee(this.value)">
                            @foreach (var emp in Model.AllEmployees)
                            {
                                <option value="@emp.Id" selected="@(emp.Id == Model.EmployeeId)">@emp.User.FirstName @emp.User.LastName</option>
                            }
                        </select>
                    }
                    else
                    {
                        <span>Pracownik: <strong>@Model.EmployeeName</strong></span>
                    }
                </div>
            </div>
            <a asp-action="Index" asp-route-date="@Model.NextWeek.ToString("yyyy-MM-dd")" asp-route-employeeId="@Model.EmployeeId" class="btn-calendar-nav">&raquo;</a>
        </div>
        <div class="timegrid-actions">
            <a asp-controller="TimeEntries" asp-action="Index" class="btn btn-secondary">Lista wpis√≥w</a>
        </div>
    </div>

    <div class="timegrid-wrapper">
        <div class="timegrid">
            <!-- Time column -->
            <div class="timegrid-time-col">
                <div class="timegrid-time-header"></div>
                @for (int hour = 0; hour < 24; hour++)
                {
                    <div class="timegrid-time-cell">
                        <span>@hour.ToString("00"):00</span>
                    </div>
                }
            </div>

            <!-- Day columns -->
            @foreach (var day in Model.DaysOfWeek)
            {
                var isToday = day.Date == DateTime.Today;
                var dayEntries = Model.EntriesByDay.ContainsKey(day) ? Model.EntriesByDay[day] : new List<TimeGridEntry>();
                var dayMarker = Model.DayMarkers.ContainsKey(day) ? Model.DayMarkers[day] : null;
                var dayTypeClass = dayMarker != null ? GetDayTypeClass(dayMarker.Type) : "";

                <div class="timegrid-day-col @(isToday ? "today" : "") @dayTypeClass" data-date="@day.ToString("yyyy-MM-dd")">
                    <div class="timegrid-day-header">
                        <div style="flex: 1;">
                            <div class="day-name">@day.ToString("ddd", new System.Globalization.CultureInfo("pl-PL"))</div>
                            <div class="day-date">@day.ToString("d MMM")</div>
                        </div>
                        <div class="day-marker-selector">
                            <button class="btn-day-marker" onclick="toggleDayMarkerMenu(event, '@day.ToString("yyyy-MM-dd")')">
                                @if (dayMarker != null)
                                {
                                    <span>@GetDayTypeIcon(dayMarker.Type)</span>
                                }
                                else
                                {
                                    <span>‚Ä¢‚Ä¢‚Ä¢</span>
                                }
                            </button>
                            <div class="day-marker-menu" id="menu-@day.ToString("yyyy-MM-dd")" style="display: none;">
                                <div class="day-marker-option" onclick="setDayMarker('@day.ToString("yyyy-MM-dd")', 1)">
                                    <span class="marker-icon" style="background: rgba(147, 51, 234, 0.2);"></span>
                                    <span>Delegacja</span>
                                    @if (dayMarker?.Type == DayType.BusinessTrip) { <span>‚úì</span> }
                                </div>
                                <div class="day-marker-option" onclick="setDayMarker('@day.ToString("yyyy-MM-dd")', 2)">
                                    <span class="marker-icon" style="background: rgba(156, 163, 175, 0.3);"></span>
                                    <span>Dzie≈Ñ wolny</span>
                                    @if (dayMarker?.Type == DayType.DayOff) { <span>‚úì</span> }
                                </div>
                                <div class="day-marker-option" onclick="setDayMarker('@day.ToString("yyyy-MM-dd")', 3)">
                                    <span class="marker-icon" style="background: rgba(234, 179, 8, 0.2);"></span>
                                    <span>Choroba</span>
                                    @if (dayMarker?.Type == DayType.Sick) { <span>‚úì</span> }
                                </div>
                                <div class="day-marker-option" onclick="setDayMarker('@day.ToString("yyyy-MM-dd")', 4)">
                                    <span class="marker-icon" style="background: rgba(244, 114, 182, 0.2);"></span>
                                    <span>Urlop</span>
                                    @if (dayMarker?.Type == DayType.Vacation) { <span>‚úì</span> }
                                </div>
                                @if (dayMarker != null)
                                {
                                    <div class="day-marker-option" onclick="removeDayMarker('@day.ToString("yyyy-MM-dd")')" style="color: var(--danger); border-top: 1px solid var(--border);">
                                        <span>√ó</span>
                                        <span>Usu≈Ñ oznaczenie</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Hour cells -->
                    <div class="timegrid-day-cells">
                        @for (int hour = 0; hour < 24; hour++)
                        {
                            <div class="timegrid-hour-cell" data-hour="@hour"></div>
                        }

                        <!-- Render existing entries -->
                        @foreach (var entry in dayEntries)
                        {
                            var startHour = entry.StartTime.TotalHours;
                            var duration = (entry.EndTime - entry.StartTime).TotalHours;
                            var top = startHour * 60; // 60px per hour
                            var height = duration * 60;

                            <div class="timegrid-entry"
                                 style="top: @(top)px; height: @(height)px;"
                                 data-entry-id="@entry.Id"
                                 data-start="@entry.StartTime.ToString()"
                                 data-end="@entry.EndTime.ToString()"
                                 data-project-id="@entry.ProjectId">
                                <div class="entry-time">@entry.StartTime.ToString(@"hh\:mm") ‚Äì @entry.EndTime.ToString(@"hh\:mm")</div>
                                <div class="entry-project">@(entry.ProjectName ?? "(brak projektu)")</div>
                                @if (!string.IsNullOrEmpty(entry.Description))
                                {
                                    <div class="entry-desc">@entry.Description</div>
                                }
                                <div class="entry-created-by">‚úçÔ∏è @entry.CreatedBy</div>
                                <button class="entry-edit" onclick="editEntry(@entry.Id)">‚úé</button>
                                <button class="entry-delete" onclick="deleteEntry(@entry.Id)">√ó</button>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="timegrid-legend">
        <div class="hint">Kliknij i przeciƒÖgnij na siatce, aby dodaƒá nowy wpis. U≈ºyj przycisku ‚Ä¢‚Ä¢‚Ä¢ w nag≈Ç√≥wku dnia, aby oznaczyƒá dzie≈Ñ.</div>
        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="display: inline-block; width: 16px; height: 16px; background: rgba(147, 51, 234, 0.2); border-radius: 3px;"></span>
                <span style="font-size: 0.875rem;">Delegacja</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="display: inline-block; width: 16px; height: 16px; background: rgba(156, 163, 175, 0.3); border-radius: 3px;"></span>
                <span style="font-size: 0.875rem;">Dzie≈Ñ wolny</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="display: inline-block; width: 16px; height: 16px; background: rgba(234, 179, 8, 0.2); border-radius: 3px;"></span>
                <span style="font-size: 0.875rem;">Choroba</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="display: inline-block; width: 16px; height: 16px; background: rgba(244, 114, 182, 0.2); border-radius: 3px;"></span>
                <span style="font-size: 0.875rem;">Urlop</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding/editing entry -->
<div id="entryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Nowy wpis czasu</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="entryId" value="" />
            <input type="hidden" id="entryDate" value="" />

            <div class="form-group">
                <label>Czas</label>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.75rem; align-items: center;">
                    <div>
                        <label style="font-size: 0.875rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Od</label>
                        <input type="time" id="entryStartTime" class="form-control" step="900" required />
                    </div>
                    <span style="margin-top: 1.5rem; color: var(--text-tertiary);">‚Äî</span>
                    <div>
                        <label style="font-size: 0.875rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Do</label>
                        <input type="time" id="entryEndTime" class="form-control" step="900" required />
                    </div>
                </div>
                <div id="durationDisplay" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"></div>
            </div>

            <div class="form-group">
                <label for="projectSelect">Projekt</label>
                <select id="projectSelect" class="form-control">
                    <option value="">(brak)</option>
                    @foreach (var project in Model.Projects)
                    {
                        <option value="@project.Id">@project.Name</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="descriptionInput">Opis</label>
                <textarea id="descriptionInput" class="form-control" rows="3" placeholder="Opisz wykonywnƒÖ pracƒô..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
            <button class="btn btn-primary" onclick="saveEntry()">Zapisz</button>
        </div>
    </div>
</div>

@functions {
    string GetDayTypeClass(DayType type)
    {
        return type switch
        {
            DayType.BusinessTrip => "day-business-trip",
            DayType.DayOff => "day-off",
            DayType.Sick => "day-sick",
            DayType.Vacation => "day-vacation",
            _ => ""
        };
    }

    string GetDayTypeIcon(DayType type)
    {
        return type switch
        {
            DayType.BusinessTrip => "üíº",
            DayType.DayOff => "üìã",
            DayType.Sick => "ü©∫",
            DayType.Vacation => "üèñÔ∏è",
            _ => ""
        };
    }
}

<script>
const employeeId = @Model.EmployeeId;
let isSelecting = false;
let selectionStart = null;
let selectionEnd = null;
let currentDayCol = null;

function changeEmployee(newEmployeeId) {
    const currentDate = '@Model.WeekStart.ToString("yyyy-MM-dd")';
    window.location.href = `@Url.Action("Index", "Calendar")?date=${currentDate}&employeeId=${newEmployeeId}`;
}

// Close day marker menu when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.day-marker-selector')) {
        document.querySelectorAll('.day-marker-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

function toggleDayMarkerMenu(event, date) {
    event.stopPropagation();
    const menu = document.getElementById(`menu-${date}`);
    const allMenus = document.querySelectorAll('.day-marker-menu');
    allMenus.forEach(m => {
        if (m !== menu) m.style.display = 'none';
    });
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

async function setDayMarker(date, type) {
    const response = await fetch('@Url.Action("SetDayMarker", "Calendar")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            employeeId: employeeId,
            date: date,
            type: type,
            note: null
        })
    });
    
    const result = await response.json();
    if (result.success) {
        location.reload();
    } else {
        alert(result.message || 'B≈ÇƒÖd ustawiania oznaczenia');
    }
}

async function removeDayMarker(date) {
    const response = await fetch('@Url.Action("RemoveDayMarker", "Calendar")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            employeeId: employeeId,
            date: date
        })
    });
    
    const result = await response.json();
    if (result.success) {
        location.reload();
    } else {
        alert(result.message || 'B≈ÇƒÖd usuwania oznaczenia');
    }
}

// Update duration display when time changes
function updateDurationDisplay() {
    const startInput = document.getElementById('entryStartTime');
    const endInput = document.getElementById('entryEndTime');
    const durationDiv = document.getElementById('durationDisplay');
    
    if (!startInput.value || !endInput.value) {
        durationDiv.textContent = '';
        return;
    }
    
    const [startH, startM] = startInput.value.split(':').map(Number);
    const [endH, endM] = endInput.value.split(':').map(Number);
    
    const startMinutes = startH * 60 + startM;
    const endMinutes = endH * 60 + endM;
    const durationMinutes = endMinutes - startMinutes;
    
    if (durationMinutes <= 0) {
        durationDiv.textContent = '‚ö†Ô∏è Czas zako≈Ñczenia musi byƒá p√≥≈∫niejszy ni≈º czas rozpoczƒôcia';
        durationDiv.style.color = 'var(--danger)';
        return;
    }
    
    const hours = Math.floor(durationMinutes / 60);
    const minutes = durationMinutes % 60;
    
    let durationText = 'Czas trwania: ';
    if (hours > 0) durationText += `${hours}h `;
    if (minutes > 0) durationText += `${minutes}min`;
    
    durationDiv.textContent = durationText;
    durationDiv.style.color = 'var(--text-secondary)';
}

// Mouse selection for creating new entries
document.querySelectorAll('.timegrid-day-col').forEach(dayCol => {
    const cells = dayCol.querySelector('.timegrid-day-cells');
    
    cells.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('timegrid-hour-cell')) {
            isSelecting = true;
            currentDayCol = dayCol;
            const hour = parseInt(e.target.dataset.hour);
            selectionStart = hour;
            selectionEnd = hour;
            updateSelection();
        }
    });
    
    cells.addEventListener('mouseover', (e) => {
        if (isSelecting && e.target.classList.contains('timegrid-hour-cell')) {
            const hour = parseInt(e.target.dataset.hour);
            selectionEnd = hour;
            updateSelection();
        }
    });
});

document.addEventListener('mouseup', () => {
    if (isSelecting) {
        isSelecting = false;
        if (selectionStart !== null && selectionEnd !== null) {
            openModalForNewEntry();
        }
    }
});

function updateSelection() {
    if (!currentDayCol) return;
    
    const cells = currentDayCol.querySelectorAll('.timegrid-hour-cell');
    cells.forEach((cell, index) => {
        const hour = parseInt(cell.dataset.hour);
        const min = Math.min(selectionStart, selectionEnd);
        const max = Math.max(selectionStart, selectionEnd);
        
        if (hour >= min && hour <= max) {
            cell.classList.add('selected');
        } else {
            cell.classList.remove('selected');
        }
    });
}

function clearSelection() {
    document.querySelectorAll('.timegrid-hour-cell').forEach(cell => {
        cell.classList.remove('selected');
    });
}

function openModalForNewEntry() {
    const min = Math.min(selectionStart, selectionEnd);
    const max = Math.max(selectionStart, selectionEnd) + 1;
    const date = currentDayCol.dataset.date;
    
    document.getElementById('modalTitle').textContent = 'Nowy wpis czasu';
    document.getElementById('entryId').value = '';
    document.getElementById('entryDate').value = date;
    document.getElementById('entryStartTime').value = `${min.toString().padStart(2, '0')}:00`;
    document.getElementById('entryEndTime').value = `${max.toString().padStart(2, '0')}:00`;
    document.getElementById('projectSelect').value = '';
    document.getElementById('descriptionInput').value = '';
    
    updateDurationDisplay();
    
    // Add event listeners for time inputs
    document.getElementById('entryStartTime').addEventListener('change', updateDurationDisplay);
    document.getElementById('entryEndTime').addEventListener('change', updateDurationDisplay);
    
    document.getElementById('entryModal').style.display = 'flex';
}

function editEntry(entryId) {
    const entryEl = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (!entryEl) return;
    
    const dayCol = entryEl.closest('.timegrid-day-col');
    const date = dayCol.dataset.date;
    const startTime = entryEl.dataset.start;
    const endTime = entryEl.dataset.end;
    const projectId = entryEl.dataset.projectId || '';
    const description = entryEl.querySelector('.entry-desc')?.textContent || '';
    
    document.getElementById('modalTitle').textContent = 'Edytuj wpis';
    document.getElementById('entryId').value = entryId;
    document.getElementById('entryDate').value = date;
    document.getElementById('entryStartTime').value = startTime.substring(0, 5);
    document.getElementById('entryEndTime').value = endTime.substring(0, 5);
    document.getElementById('projectSelect').value = projectId;
    document.getElementById('descriptionInput').value = description;
    
    updateDurationDisplay();
    
    // Add event listeners for time inputs
    document.getElementById('entryStartTime').addEventListener('change', updateDurationDisplay);
    document.getElementById('entryEndTime').addEventListener('change', updateDurationDisplay);
    
    document.getElementById('entryModal').style.display = 'flex';
}

async function deleteEntry(entryId) {
    if (!confirm('Czy na pewno usunƒÖƒá ten wpis?')) return;
    
    const response = await fetch('@Url.Action("DeleteEntry", "Calendar")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id: entryId })
    });
    
    const result = await response.json();
    if (result.success) {
        location.reload();
    } else {
        alert(result.message || 'B≈ÇƒÖd usuwania wpisu');
    }
}

function closeModal() {
    document.getElementById('entryModal').style.display = 'none';
    clearSelection();
    selectionStart = null;
    selectionEnd = null;
    currentDayCol = null;
}

async function saveEntry() {
    const entryId = document.getElementById('entryId').value;
    const date = document.getElementById('entryDate').value;
    const startTime = document.getElementById('entryStartTime').value + ':00';
    const endTime = document.getElementById('entryEndTime').value + ':00';
    const projectId = document.getElementById('projectSelect').value || null;
    const description = document.getElementById('descriptionInput').value;
    
    // Walidacja czasu
    const [startH, startM] = document.getElementById('entryStartTime').value.split(':').map(Number);
    const [endH, endM] = document.getElementById('entryEndTime').value.split(':').map(Number);
    const startMinutes = startH * 60 + startM;
    const endMinutes = endH * 60 + endM;
    
    if (endMinutes <= startMinutes) {
        alert('Czas zako≈Ñczenia musi byƒá p√≥≈∫niejszy ni≈º czas rozpoczƒôcia');
        return;
    }
    
    if (entryId) {
        // Update existing
        const response = await fetch('@Url.Action("UpdateEntry", "Calendar")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: parseInt(entryId),
                startTime: startTime,
                endTime: endTime,
                projectId: projectId ? parseInt(projectId) : null,
                description: description
            })
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.message || 'B≈ÇƒÖd aktualizacji wpisu');
        }
    } else {
        // Add new
        const response = await fetch('@Url.Action("AddEntry", "Calendar")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                employeeId: employeeId,
                date: date,
                startTime: startTime,
                endTime: endTime,
                projectId: projectId ? parseInt(projectId) : null,
                description: description
            })
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.message || 'B≈ÇƒÖd dodawania wpisu');
        }
    }
}
</script>

@section Scripts {
    @Html.AntiForgeryToken()
}
