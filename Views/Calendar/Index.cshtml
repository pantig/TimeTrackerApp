@using TimeTrackerApp.Models.ViewModels
@model WeeklyTimeGridViewModel

@{
    ViewData["Title"] = "Kalendarz Tygodniowy";
}

<div class="timegrid-container">
    <div class="timegrid-header">
        <div class="timegrid-nav">
            <a asp-action="Index" asp-route-date="@Model.PrevWeek.ToString("yyyy-MM-dd")" asp-route-employeeId="@Model.EmployeeId" class="btn-calendar-nav">&laquo;</a>
            <div class="timegrid-title">
                <h2>@Model.WeekStart.ToString("d MMM") – @Model.WeekEnd.ToString("d MMM yyyy")</h2>
                <div class="muted">
                    @if (Model.CanSelectEmployee && Model.AllEmployees != null)
                    {
                        <span>Pracownik: </span>
                        <select id="employeeSelect" class="employee-select" onchange="changeEmployee(this.value)">
                            @foreach (var emp in Model.AllEmployees)
                            {
                                <option value="@emp.Id" selected="@(emp.Id == Model.EmployeeId)">@emp.User.FirstName @emp.User.LastName</option>
                            }
                        </select>
                    }
                    else
                    {
                        <span>Pracownik: <strong>@Model.EmployeeName</strong></span>
                    }
                </div>
            </div>
            <a asp-action="Index" asp-route-date="@Model.NextWeek.ToString("yyyy-MM-dd")" asp-route-employeeId="@Model.EmployeeId" class="btn-calendar-nav">&raquo;</a>
        </div>
        <div class="timegrid-actions">
            <a asp-controller="TimeEntries" asp-action="Index" class="btn btn-secondary">Lista wpisów</a>
        </div>
    </div>

    <div class="timegrid-wrapper">
        <div class="timegrid">
            <!-- Time column -->
            <div class="timegrid-time-col">
                <div class="timegrid-time-header"></div>
                @for (int hour = 0; hour < 24; hour++)
                {
                    <div class="timegrid-time-cell">
                        <span>@hour.ToString("00"):00</span>
                    </div>
                }
            </div>

            <!-- Day columns -->
            @foreach (var day in Model.DaysOfWeek)
            {
                var isToday = day.Date == DateTime.Today;
                var dayEntries = Model.EntriesByDay.ContainsKey(day) ? Model.EntriesByDay[day] : new List<TimeGridEntry>();

                <div class="timegrid-day-col @(isToday ? "today" : "")" data-date="@day.ToString("yyyy-MM-dd")">
                    <div class="timegrid-day-header">
                        <div class="day-name">@day.ToString("ddd", new System.Globalization.CultureInfo("pl-PL"))</div>
                        <div class="day-date">@day.ToString("d MMM")</div>
                    </div>

                    <!-- Hour cells -->
                    <div class="timegrid-day-cells">
                        @for (int hour = 0; hour < 24; hour++)
                        {
                            <div class="timegrid-hour-cell" data-hour="@hour"></div>
                        }

                        <!-- Render existing entries -->
                        @foreach (var entry in dayEntries)
                        {
                            var startHour = entry.StartTime.TotalHours;
                            var duration = (entry.EndTime - entry.StartTime).TotalHours;
                            var top = startHour * 60; // 60px per hour
                            var height = duration * 60;

                            <div class="timegrid-entry"
                                 style="top: @(top)px; height: @(height)px;"
                                 data-entry-id="@entry.Id"
                                 data-start="@entry.StartTime.ToString()"
                                 data-end="@entry.EndTime.ToString()"
                                 data-project-id="@entry.ProjectId">
                                <div class="entry-time">@entry.StartTime.ToString(@"hh\:mm") – @entry.EndTime.ToString(@"hh\:mm")</div>
                                <div class="entry-project">@(entry.ProjectName ?? "(brak projektu)")</div>
                                @if (!string.IsNullOrEmpty(entry.Description))
                                {
                                    <div class="entry-desc">@entry.Description</div>
                                }
                                <div class="entry-created-by">✍️ @entry.CreatedBy</div>
                                <button class="entry-edit" onclick="editEntry(@entry.Id)">✎</button>
                                <button class="entry-delete" onclick="deleteEntry(@entry.Id)">×</button>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="timegrid-legend">
        <div class="hint">Kliknij i przeciągnij na siatce, aby dodać nowy wpis</div>
    </div>
</div>

<!-- Modal for adding/editing entry -->
<div id="entryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Nowy wpis czasu</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="entryId" value="" />
            <input type="hidden" id="entryDate" value="" />
            <input type="hidden" id="entryStartTime" value="" />
            <input type="hidden" id="entryEndTime" value="" />

            <div class="form-group">
                <label>Czas</label>
                <div id="timeDisplay" class="time-display"></div>
            </div>

            <div class="form-group">
                <label for="projectSelect">Projekt</label>
                <select id="projectSelect" class="form-control">
                    <option value="">(brak)</option>
                    @foreach (var project in Model.Projects)
                    {
                        <option value="@project.Id">@project.Name</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="descriptionInput">Opis</label>
                <textarea id="descriptionInput" class="form-control" rows="3" placeholder="Opisz wykonaną pracę..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
            <button class="btn btn-primary" onclick="saveEntry()">Zapisz</button>
        </div>
    </div>
</div>

<script>
const employeeId = @Model.EmployeeId;
let isSelecting = false;
let selectionStart = null;
let selectionEnd = null;
let currentDayCol = null;

function changeEmployee(newEmployeeId) {
    const currentDate = '@Model.WeekStart.ToString("yyyy-MM-dd")';
    window.location.href = `@Url.Action("Index", "Calendar")?date=${currentDate}&employeeId=${newEmployeeId}`;
}

// Mouse selection for creating new entries
document.querySelectorAll('.timegrid-day-col').forEach(dayCol => {
    const cells = dayCol.querySelector('.timegrid-day-cells');
    
    cells.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('timegrid-hour-cell')) {
            isSelecting = true;
            currentDayCol = dayCol;
            const hour = parseInt(e.target.dataset.hour);
            selectionStart = hour;
            selectionEnd = hour;
            updateSelection();
        }
    });
    
    cells.addEventListener('mouseover', (e) => {
        if (isSelecting && e.target.classList.contains('timegrid-hour-cell')) {
            const hour = parseInt(e.target.dataset.hour);
            selectionEnd = hour;
            updateSelection();
        }
    });
});

document.addEventListener('mouseup', () => {
    if (isSelecting) {
        isSelecting = false;
        if (selectionStart !== null && selectionEnd !== null) {
            openModalForNewEntry();
        }
    }
});

function updateSelection() {
    if (!currentDayCol) return;
    
    const cells = currentDayCol.querySelectorAll('.timegrid-hour-cell');
    cells.forEach((cell, index) => {
        const hour = parseInt(cell.dataset.hour);
        const min = Math.min(selectionStart, selectionEnd);
        const max = Math.max(selectionStart, selectionEnd);
        
        if (hour >= min && hour <= max) {
            cell.classList.add('selected');
        } else {
            cell.classList.remove('selected');
        }
    });
}

function clearSelection() {
    document.querySelectorAll('.timegrid-hour-cell').forEach(cell => {
        cell.classList.remove('selected');
    });
}

function openModalForNewEntry() {
    const min = Math.min(selectionStart, selectionEnd);
    const max = Math.max(selectionStart, selectionEnd) + 1;
    const date = currentDayCol.dataset.date;
    
    document.getElementById('modalTitle').textContent = 'Nowy wpis czasu';
    document.getElementById('entryId').value = '';
    document.getElementById('entryDate').value = date;
    document.getElementById('entryStartTime').value = `${min.toString().padStart(2, '0')}:00:00`;
    document.getElementById('entryEndTime').value = `${max.toString().padStart(2, '0')}:00:00`;
    document.getElementById('timeDisplay').textContent = `${min.toString().padStart(2, '0')}:00 – ${max.toString().padStart(2, '0')}:00`;
    document.getElementById('projectSelect').value = '';
    document.getElementById('descriptionInput').value = '';
    
    document.getElementById('entryModal').style.display = 'flex';
}

function editEntry(entryId) {
    const entryEl = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (!entryEl) return;
    
    const dayCol = entryEl.closest('.timegrid-day-col');
    const date = dayCol.dataset.date;
    const startTime = entryEl.dataset.start;
    const endTime = entryEl.dataset.end;
    const projectId = entryEl.dataset.projectId || '';
    const description = entryEl.querySelector('.entry-desc')?.textContent || '';
    
    document.getElementById('modalTitle').textContent = 'Edytuj wpis';
    document.getElementById('entryId').value = entryId;
    document.getElementById('entryDate').value = date;
    document.getElementById('entryStartTime').value = startTime;
    document.getElementById('entryEndTime').value = endTime;
    document.getElementById('timeDisplay').textContent = `${startTime.substring(0, 5)} – ${endTime.substring(0, 5)}`;
    document.getElementById('projectSelect').value = projectId;
    document.getElementById('descriptionInput').value = description;
    
    document.getElementById('entryModal').style.display = 'flex';
}

async function deleteEntry(entryId) {
    if (!confirm('Czy na pewno usunąć ten wpis?')) return;
    
    const response = await fetch('@Url.Action("DeleteEntry", "Calendar")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
        },
        body: JSON.stringify({ id: entryId })
    });
    
    const result = await response.json();
    if (result.success) {
        location.reload();
    } else {
        alert(result.message || 'Błąd usuwania wpisu');
    }
}

function closeModal() {
    document.getElementById('entryModal').style.display = 'none';
    clearSelection();
    selectionStart = null;
    selectionEnd = null;
    currentDayCol = null;
}

async function saveEntry() {
    const entryId = document.getElementById('entryId').value;
    const date = document.getElementById('entryDate').value;
    const startTime = document.getElementById('entryStartTime').value;
    const endTime = document.getElementById('entryEndTime').value;
    const projectId = document.getElementById('projectSelect').value || null;
    const description = document.getElementById('descriptionInput').value;
    
    if (entryId) {
        // Update existing
        const response = await fetch('@Url.Action("UpdateEntry", "Calendar")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify({
                id: parseInt(entryId),
                projectId: projectId ? parseInt(projectId) : null,
                description: description
            })
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.message || 'Błąd aktualizacji wpisu');
        }
    } else {
        // Add new
        const response = await fetch('@Url.Action("AddEntry", "Calendar")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify({
                employeeId: employeeId,
                date: date,
                startTime: startTime,
                endTime: endTime,
                projectId: projectId ? parseInt(projectId) : null,
                description: description
            })
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.message || 'Błąd dodawania wpisu');
        }
    }
}
</script>

@section Scripts {
    @Html.AntiForgeryToken()
}
